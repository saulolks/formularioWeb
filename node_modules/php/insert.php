<?php

include("conexao.php");
include("uuidGen.php");

$nome = mysqli_real_escape_string($con, $_POST["inputNome"]);
$nasc = mysqli_real_escape_string($con, $_POST["inputNasc"]);
$cpf = mysqli_real_escape_string($con, $_POST["inputCpf"]);
$cep = mysqli_real_escape_string($con, $_POST["inputCep"]);
$rua = mysqli_real_escape_string($con, $_POST["inputEndereco"]);
$num = mysqli_real_escape_string($con, $_POST["inputNum"]);
$bairro = mysqli_real_escape_string($con, $_POST["inputBairro"]);
$cidade = mysqli_real_escape_string($con, $_POST["inputCidade"]);
$estado = mysqli_real_escape_string($con, $_POST["inputEstado"]);
$complemento = mysqli_real_escape_string($con, $_POST["inputComplemento"]);

# TRATAR CPF
$chars = array("-" , "," , ".");
$cpf = str_replace($chars,"",$cpf);
$sizecpf = strlen($cpf);
$cpf = intval($cpf);

# GERAR UUID
$id = sprintf('%04x%04x-%04x-%04x-%04x-%04x%04x%04x', mt_rand(0, 0xffff), mt_rand(0, 0xffff), mt_rand(0, 0xffff), mt_rand(0, 0x0fff) | 0x4000, mt_rand(0, 0x3fff) | 0x8000, mt_rand(0, 0xffff), mt_rand(0, 0xffff), mt_rand(0, 0xffff));

# TRATAR CEP
$chars = array("-" , "," , ".");
$cep = str_replace($chars,"",$cep);
$cep = intval($cep);
$sizecep = strlen($cep);

# VALIDAR CPF E CEP

$msg = " ";
$sql = " ";

if($sizecpf != 11){
	$msg = "O CPF informado é inválido!";
}else if($sizecep != 8){
	$msg = "O CEP informado é inválido!";
}else{
	# TRATAR NUMERO NULO
	if($num == ""){
		$sql = "INSERT INTO pessoa(id, nome, nascimento, cpf, cep, rua, numero, bairro, cidade, estado, complemento) 
		VALUES ('$id', '$nome', '$nasc', '$cpf', '$cep', '$rua', null, '$bairro', '$cidade', '$estado', '$complemento')";
	}
	else{
		$sql = "INSERT INTO pessoa(id, nome, nascimento, cpf, cep, rua, numero, bairro, cidade, estado, complemento) 
		VALUES ('$id', '$nome', '$nasc', '$cpf', '$cep', '$rua', '$num', '$bairro', '$cidade', '$estado', '$complemento')";
	}
}

?>

<!doctype html>
<html lang="pt-br">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../bootstrap/compiler/bootstrap.css">
    <link rel="stylesheet" href="../font-awesome/css/font-awesome.css">

    <title>Formulário de Cadastro</title>

    <style>
        body{
            background-color: white;
        }
        .container{
            border: 2px solid black;
            background-color: white  ;
            border-radius: 10px;
            width: 1500px;
        }
        table{
            border: 2px solid #212529;
            border-radius: 10px;
        }
        button{
            margin-bottom: 10px;
            border: 5px solid black;
        }
    </style>

</head>

<script language="JavaScript" src="node_modules/java-script/funcoes.js"></script>

<body>

    <div class="container">

            <div class="row">

                <div class="col-12 text-center my-5">
                    <h1 class="display-4"> Confirmação de Cadastro <i class="fa fa-check"></i></h1>
                </div>

            </div>

             <!-- CASO SEJA BEM SUCEDIDO -->

            <?php  
                	if ($con->query($sql) === TRUE) {
             ?>

            <div class="alert alert-success" role="alert">Pessoa cadastrada com sucesso!</div>
                
            <table class="table table-striped">
                

                <thead class="thead-dark">
                    <tr>
                    <th scope="col">ID</th>
                    <th scope="col">Nome</th>
                    <th scope="col">Data de Nascimento</th>
                    <th scope="col">CPF</th>
                    <th scope="col">CEP</th>
                    <th scope="col">Endereço</th>
                    <th scope="col">Número</th>
                    <th scope="col">Bairro</th>
                    <th scope="col">Cidade</th>
                    <th scope="col">Estado</th>
                    <th scope="col">Complemento</th>
                    </tr>
                </thead>

                <tbody>
                    <tr>
                    <th scope="row"> <?php echo $id; ?> </th>
               	    <td> <?php echo $nome; ?> </td>
                    <td> <?php echo $nasc; ?> </td>
                    <td> <?php echo $cpf; ?> </td>
                    <td> <?php echo $cep; ?> </td>
                    <td> <?php echo $rua; ?> </td>
                    <td> <?php echo $num; ?> </td>
                    <td> <?php echo $bairro; ?> </td>
                    <td> <?php echo $cidade; ?> </td>
                    <td> <?php echo $estado; ?> </td>
                    <td> <?php echo $complemento; ?> </td>
                    </tr>   
                </tbody>

                <button type="button" class="btn btn-light" onclick="location.href= '../../index.php'">Cadastrar outro</button>
                <button type="button" class="btn btn-light" onclick="location.href= '../../tabelaConsulta.php'">Ver cadastrados</button>

                <!-- CASO NÃO SEJA BEM SUCEDIDO -->
                <?php  
                	}
                	else if($msg != " "){
                ?>
                		<div class="alert alert-danger" role="alert"> <?php echo "Error: " . $msg . "<br>"; ?> </div>
                	
                <?php  
                	}else{
                ?>
                		<div class="alert alert-danger" role="alert"> <?php echo "Error: " . $sql . "<br>" . $con->error; ?> </div>
                <?php  
                	}
                ?>

                <button type="button" class="btn btn-outline-secondary" onclick="location.href= '../../index.php'">Tentar outro</button>
                <button type="button" class="btn btn-outline-secondary" onclick="location.href= '../../tabelaConsulta.php'">Ver cadastrados</button>

            </table>

    </div>

    <script src="../jquery/dist/jquery.js"></script>
    <script src="../popper.js/dist/popper.js"></script>
    <script src="../bootstrap/dist/js/bootstrap.js"></script>
    <script type="text/javascript" src="../jquery/dist/jquery.mask.min.js"></script>

    <script type="text/javascript">
    $("#inputCpf").mask("000.000.000-00")
        $("#inputCep").mask("00.000-000")
        </script>

</body>
</html>
